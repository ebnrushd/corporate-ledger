# Ledger and Visa Top-Up Integration System

## Project Overview

This project is a prototype system demonstrating the integration of a local ledger, a smart contract for Visa top-up operations, and an API service that orchestrates interactions between them. It includes placeholder modules for ERP integration and Visa API client interactions, along with a basic frontend UI for initiating top-ups and viewing transaction history. The primary goal is to showcase a potential architecture for managing financial transactions with on-chain components.

**Disclaimer:** This is a prototype system and is **NOT production-ready**. It lacks many security features, comprehensive error handling, and real integrations necessary for a live environment.

## Components

The project is structured into several key components:

1.  **Database Schema (`schema.sql`)**:
    *   Defines the PostgreSQL database schema for the ledger system.
    *   Includes tables for `accounts`, `transactions`, `balances`, and `serial_boxes`.

2.  **Ledger Processing (`ledger_processing/`)**:
    *   `data_processor.py`: Contains Python modules for processing (simulated) encrypted bank raw data. This includes decryption, validation, parsing, and storing data into the PostgreSQL database.
    *   `erp_connector.py`: A placeholder module for future ERP (Enterprise Resource Planning) system integration.
    *   `requirements.txt`: Specifies Python libraries for this component.

3.  **Smart Contracts (`smart_contracts/`)**:
    *   `VisaTopUp.sol`: A Solidity smart contract for initiating and confirming Visa top-up requests on an Ethereum-compatible blockchain. It uses events to communicate with off-chain services.

4.  **Integration Service (`integration_service/`)**:
    *   `app.py`: A Flask-based API service that acts as the central hub.
        *   Exposes endpoints for initiating top-ups and receiving (simulated) Visa confirmations.
        *   Interacts with the PostgreSQL ledger database.
        *   Interacts with the `VisaTopUp.sol` smart contract via Web3.py.
    *   `visa_api_client.py`: A placeholder client for simulating interactions with a Visa API for card top-ups.
    *   `.env_example`: Template for environment variables required by the service.
    *   `requirements.txt`: Specifies Python libraries for this API service.

5.  **Frontend (UI) (`frontend/`)**:
    *   `login.html`: A placeholder login page (simulated login).
    *   `initiate_topup.html`: A basic HTML form to initiate a Visa top-up via the integration service.
    *   `transaction_history.html`: A basic HTML page to display transaction history fetched from the integration service.
    *   `scripts/main.js`: JavaScript to handle form submissions, API calls to the integration service, and dynamic content updates on the frontend pages.

6.  **Scripts (`scripts/`)**:
    *   `deploy_visa_top_up.py`: A Python script using Web3.py to deploy the `VisaTopUp.sol` smart contract.
    *   `interact_visa_top_up.py`: A Python script to interact with the deployed smart contract (e.g., set backend address, call functions).
    *   `deployment_info.json` (generated by `deploy_visa_top_up.py`): Stores the deployed contract address and ABI.

7.  **Tests (`tests/`)**:
    *   `tests/ledger_processing/test_data_processor.py`: Unit tests for the `data_processor.py` module, covering encryption/decryption, validation, parsing, and mocked database interactions.

## Setup and Installation Instructions

### Prerequisites

*   **Python:** Version 3.8+
*   **PostgreSQL:** A running PostgreSQL server.
*   **Solidity Compiler (`solc`):** Required by `py-solc-x` for deploying smart contracts. Can often be installed via system package managers or `solcx.install_solc('0.8.18')` within Python.
*   **Ethereum Node:**
    *   A local development blockchain like [Ganache](https://trufflesuite.com/ganache/) (recommended for local testing).
    *   Alternatively, access to a testnet/mainnet node via Infura, Alchemy, etc.
*   **Git:** For cloning the repository.

### 1. Clone the Repository

```bash
git clone <repository_url>
cd <repository_name>
```

### 2. Python Environment Setup

It's highly recommended to use a virtual environment for Python projects.

```bash
# Create a virtual environment
python3 -m venv venv

# Activate the virtual environment
# On macOS and Linux:
source venv/bin/activate
# On Windows:
# venv\Scripts\activate

# Install project-wide Python dependencies from the root requirements.txt
# (This file should ideally aggregate all requirements)
# For now, install requirements for each component separately or create a root one.
# Assuming a root requirements.txt exists or you create one combining:
# - ledger_processing/requirements.txt
# - integration_service/requirements.txt
# - web3.py, py-solc-x (for scripts)
pip install -r requirements.txt
# If no root requirements.txt, cd into ledger_processing and integration_service and pip install -r requirements.txt from there.
# Also ensure web3 and py-solc-x are installed for the scripts/ directory.
# pip install web3 py-solc-x cryptography psycopg2-binary Flask python-dotenv
```
*(Note: A root `requirements.txt` was created in previous steps, ensure it's up-to-date or instruct users to install component-specific ones).*

### 3. Database Setup

1.  Ensure your PostgreSQL server is running.
2.  Create a database and a user for the application (e.g., database `ledger_db`, user `ledger_user`).
    ```sql
    -- Example psql commands:
    CREATE DATABASE ledger_db;
    CREATE USER ledger_user WITH PASSWORD 'your_secure_password';
    GRANT ALL PRIVILEGES ON DATABASE ledger_db TO ledger_user;
    ALTER ROLE ledger_user SET client_encoding TO 'utf8';
    ALTER ROLE ledger_user SET default_transaction_isolation TO 'read committed';
    ALTER ROLE ledger_user SET timezone TO 'UTC';
    ```
3.  Apply the schema:
    ```bash
    psql -U ledger_user -d ledger_db -h localhost -f schema.sql
    ```
    You might be prompted for the password for `ledger_user`.

### 4. Smart Contract Deployment

1.  **Configure Deployer Account:**
    *   Edit `scripts/deploy_visa_top_up.py`.
    *   Set `ETH_NODE_URL` to your Ethereum node's RPC URL (e.g., `http://127.0.0.1:8545` for Ganache).
    *   Replace `DEPLOYER_PRIVATE_KEY` with the private key of an account on your Ethereum node that has sufficient funds for deployment. **Never commit real private keys.**
2.  **Encryption Key for `data_processor` (if using its encryption features for other data):**
    *   The `ledger_processing/data_processor.py` module might attempt to generate a `secret.key` for Fernet encryption upon first import if it doesn't exist. This key is **not directly related** to smart contract private keys but is for data encryption within that module. For consistency, especially if tests are run, ensure this key is handled or generated as needed by that module.
3.  **Run the Deployment Script:**
    ```bash
    python scripts/deploy_visa_top_up.py
    ```
    This will compile and deploy `VisaTopUp.sol` and create `scripts/deployment_info.json` containing the contract address and ABI.

### 5. Integration Service Setup

1.  **Environment Variables:**
    *   Navigate to the `integration_service` directory.
    *   Copy `.env_example` to a new file named `.env`:
        ```bash
        cp integration_service/.env_example integration_service/.env
        ```
    *   Edit `integration_service/.env` and fill in the required values:
        *   `DB_HOST`, `DB_NAME`, `DB_USER`, `DB_PASSWORD`, `DB_PORT` for your PostgreSQL setup.
        *   `ETH_NODE_URL` for your Ethereum node.
        *   `CONTRACT_DEPLOYMENT_INFO_PATH`: Should be `../scripts/deployment_info.json` (relative to `integration_service/app.py`).
        *   `API_SERVICE_PRIVATE_KEY`: The private key for the Ethereum account that the API service will use to interact with the smart contract. This account **must be set as the `authorizedBackendAddress`** in the `VisaTopUp` smart contract (see step 6). Ensure this account has ETH if it needs to send transactions that require gas.
        *   `FLASK_APP`, `FLASK_ENV`, `FLASK_DEBUG`, `API_PORT`.
2.  **Set Authorized Backend in Smart Contract:**
    *   The `API_SERVICE_PRIVATE_KEY` you configured in `.env` corresponds to an Ethereum address. This address needs to be authorized in the smart contract.
    *   Edit `scripts/interact_visa_top_up.py`:
        *   Ensure `ETH_NODE_URL` is correct.
        *   Set `OWNER_PRIVATE_KEY` to the private key of the account that deployed the contract (the owner).
        *   Set `BACKEND_PRIVATE_KEY` to the **same private key** as `API_SERVICE_PRIVATE_KEY` in your `.env` file.
    *   Run the script to call `setAuthorizedBackend()`:
        ```bash
        # Ensure deployment_info.json exists in scripts/
        python scripts/interact_visa_top_up.py
        ```
        Follow the script's output to confirm the backend address was set. The script will attempt other interactions too, which can be observed.
3.  **Run the Integration Service:**
    ```bash
    cd integration_service
    # Ensure your virtual environment is active
    flask run
    # Or python app.py
    ```
    The service should start, typically on `http://localhost:5000`. Check the logs for any errors.

### 6. Frontend UI

*   The frontend files (`frontend/*.html`, `frontend/scripts/main.js`) are basic HTML and JavaScript.
*   You can open `frontend/login.html` or `frontend/initiate_topup.html` directly in your web browser (`file:///path/to/your/project/frontend/login.html`).
*   For API interactions to work (e.g., from `initiate_topup.html`), the `integration_service` (Flask app) must be running and accessible (default `http://localhost:5000`).

## Running the Application (General Flow)

1.  **Start PostgreSQL Server:** Ensure it's running and accessible.
2.  **Deploy Smart Contract:** If not already deployed, run `python scripts/deploy_visa_top_up.py`. Note the contract address.
3.  **Configure and Start Integration Service:**
    *   Update `integration_service/.env` with the correct database credentials, Ethereum node URL, the deployed smart contract address (from `deployment_info.json`), and the `API_SERVICE_PRIVATE_KEY`.
    *   If the `authorizedBackendAddress` in the smart contract is not yet set to the API service's account, run `scripts/interact_visa_top_up.py` to set it.
    *   Start the Flask app: `cd integration_service && flask run`.
4.  **Access Frontend:**
    *   Open `frontend/login.html` in your browser to simulate login.
    *   Navigate to `frontend/initiate_topup.html` to try initiating a top-up.
    *   Navigate to `frontend/transaction_history.html` to view transactions.

## Running Tests

Unit tests are provided for the `ledger_processing` module.

1.  Ensure your Python virtual environment is active and `psycopg2-binary`, `cryptography` are installed.
2.  From the **project root directory**:
    ```bash
    python -m unittest discover -s tests -p "test_*.py"
    ```
    Or, to run a specific test file:
    ```bash
    python tests/ledger_processing/test_data_processor.py
    ```

## Key Configuration Points

*   **`ledger_processing/data_processor.py`**:
    *   `ENCRYPTION_KEY` / `secret.key`: This module handles its own Fernet encryption key. If `secret.key` is not present, it might be auto-generated on first use. For consistent behavior across environments or for tests, manage this key explicitly.
*   **`integration_service/.env`** (after copying from `.env_example`):
    *   `DB_HOST, DB_NAME, DB_USER, DB_PASSWORD, DB_PORT`: Critical for database connection.
    *   `ETH_NODE_URL`: URL of your Ethereum node.
    *   `CONTRACT_DEPLOYMENT_INFO_PATH`: Path to `deployment_info.json`.
    *   `API_SERVICE_PRIVATE_KEY`: **Highly sensitive.** Private key of the account the API uses to interact with the smart contract. This account must be funded if sending transactions that require gas and must be the `authorizedBackendAddress` in the smart contract.
*   **`scripts/deploy_visa_top_up.py`**:
    *   `ETH_NODE_URL`, `DEPLOYER_PRIVATE_KEY`.
*   **`scripts/interact_visa_top_up.py`**:
    *   `ETH_NODE_URL`, `OWNER_PRIVATE_KEY`, `BACKEND_PRIVATE_KEY`.

## Security Notes

*   **Prototype System:** This code is for demonstration and learning. **DO NOT USE IN PRODUCTION WITHOUT SIGNIFICANT MODIFICATIONS AND SECURITY AUDITS.**
*   **Key Management:**
    *   Private keys (`DEPLOYER_PRIVATE_KEY`, `API_SERVICE_PRIVATE_KEY`, `OWNER_PRIVATE_KEY`) are handled insecurely in scripts and environment files for simplicity. In production, use secure key management solutions (e.g., hardware wallets, HSMs, environment-provided KMS like AWS KMS, Azure Key Vault, HashiCorp Vault).
    *   The Fernet `secret.key` for `data_processor` also needs secure management.
*   **API Security:**
    *   The Flask development server is not suitable for production. Use a production-grade WSGI server (e.g., Gunicorn, uWSGI) behind a reverse proxy (e.g., Nginx).
    *   Implement proper authentication and authorization for all API endpoints.
    *   Enforce HTTPS for all communication.
    *   Add rate limiting, input sanitization beyond basic validation, and output encoding where necessary.
    *   Implement security headers (CSP, HSTS, X-Frame-Options, etc.).
*   **Database Security:** Use strong, unique passwords for the database user. Limit permissions to the minimum required. Consider network restrictions.
*   **Smart Contract Security:** While basic, the `VisaTopUp.sol` contract should undergo a security audit if it were to handle real value. Current access controls (`onlyOwner`, `onlyAuthorizedBackend`) are fundamental but part of a broader security posture.
*   **PCI DSS:** Handling even the last four digits of a card number (`visa_card_last_four`) has PCI DSS implications. Real card processing systems require strict adherence to PCI DSS standards, which is not covered by this prototype.
*   **Error Handling:** Current error handling is basic. Production systems need robust and user-friendly error management that doesn't leak sensitive information.
*   **Dependency Management:** Keep all libraries up-to-date and scan for vulnerabilities.

## Future Enhancements / Roadmap

*   **Real Visa API Integration:** Replace the placeholder `VisaApiClient` with actual calls to Visa APIs.
*   **Real ERP Integration:** Develop the `erp_connector.py` to connect with a specific ERP system.
*   **Production-Ready UI/UX:** Develop a full-fledged frontend application using a modern framework (e.g., React, Vue, Angular).
*   **Comprehensive Test Suite:** Add more unit tests, integration tests between components, and end-to-end (E2E) tests.
*   **Robust Authentication & Authorization:**
    *   Implement secure user authentication for the frontend and API service (e.g., OAuth 2.0, JWTs).
    *   Fine-grained authorization and role-based access control (RBAC).
*   **Scalability & Performance:** Optimize database queries, API responses, and potentially introduce caching or message queues for high-load scenarios.
*   **Monitoring & Alerting:** Integrate logging with monitoring tools (e.g., Prometheus, Grafana, ELK stack) and set up alerts for critical errors or suspicious activities.
*   **Configuration Management:** Use more robust configuration management for different environments (dev, staging, prod).
*   **Idempotency:** Ensure all critical operations (especially those involving payments or state changes) are idempotent.
*   **Data Migration Strategy:** For schema changes in the database.
*   **Advanced Smart Contract Features:** Consider upgradable contracts, more complex state management, or interaction with other DeFi protocols if applicable.

---

This README aims to provide a comprehensive starting point for understanding and working with this project.
Remember to replace placeholder values and exercise caution with sensitive information like private keys.
